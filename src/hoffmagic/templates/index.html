{% extends "base.html" %}
{% block title %}hoffmagic blog{% endblock %}
{% block description %}hoffmagic - a beautiful blog featuring insightful articles and essays{% endblock %}
{% block content %}

    <section id="latest-content">
        {# Content will be loaded dynamically or passed via context #}
        <h2>Latest Writing</h2>
        <div id="posts-list">
             <p>Loading...</p>
             {# Example structure for dynamically loaded posts #}
             <!--
             <article style="margin-bottom: 2.5em;">
                 <h3><a href="/blog/{post.slug}">Post Title</a></h3>
                 <p style="font-size: 0.9em; color: var(--color-text-secondary); margin-bottom: 0.5em;">{Formatted Date}</p>
                 <p>{post.summary}</p>
                 <a href="/blog/{post.slug}" style="font-size: 0.9em; color: var(--color-accent);">Read More →</a>
             </article>
             -->
        </div>

         {# Optional: Separator or more space before newsletter #}
         <hr> {# Use the globally styled hr #}

        {# Plain newsletter signup #}
        <div class="newsletter-section">
             <h3>Subscribe</h3>
             <p>Get new posts and essays delivered directly to your inbox.</p>
            <form id="home-newsletter-form" style="margin-top: 1em;">
                <label for="newsletter-email" style="display: block; margin-bottom: 0.5em; font-size: 0.9em;">Email Address:</label>
                <div style="display: flex; gap: 0.5em;">
                     <input type="email" id="newsletter-email" name="email" placeholder="you@example.com" required
                            style="flex-grow: 1;"> {# Input inherits base styles #}
                     <button type="submit">Subscribe</button> {# Button inherits base styles #}
                </div>
             <p id="newsletter-feedback" style="font-size: 0.9em; margin-top: 0.5em;"></p>
            </form>
        </div>

    </section>

{% endblock %}

{% block scripts %}
<script>
    // Simplified content loading for the homepage
    async function loadLatestContent() {
        const container = document.getElementById('posts-list');
        container.innerHTML = '<p>Loading...</p>'; // Reset container

        try {
            // Fetch both posts and essays (or adjust API to return merged list)
            // Let's assume API fetches latest 5 blog posts for now
            const response = await fetch('/api/blog?page=1&page_size=5'); // Adjust endpoint/params as needed
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (data.items && data.items.length > 0) {
                renderLatest(data.items);
            } else {
                container.innerHTML = '<p>No recent posts found.</p>';
            }
        } catch (error) {
            console.error('Error loading latest content:', error);
            container.innerHTML = `<p>Failed to load content. Please try again later.</p>`;
        }
    }

    // Function to render latest posts/essays to the DOM in minimalist style
    function renderLatest(items) {
        const container = document.getElementById('posts-list');
        const dateFormatter = new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        container.innerHTML = items.map(item => `
            <article style="margin-bottom: 2.5em;">
                 <h3><a href="/${item.is_essay ? 'essays' : 'blog'}/${item.slug}">${item.title}</a></h3>
                 <p style="font-size: 0.9em; color: var(--color-text-secondary); margin-top: 0.2em; margin-bottom: 0.5em;">
                    ${dateFormatter.format(new Date(item.publish_date))}
                 </p>
                ${item.summary ? `<p>${item.summary}</p>` : ''}
                <a href="/${item.is_essay ? 'essays' : 'blog'}/${item.slug}" style="font-size: 0.9em; color: var(--color-accent);">Read More →</a>
             </article>
         `).join('');
    }

    // Newsletter form submission
    async function handleNewsletterSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const emailInput = form.querySelector('#newsletter-email');
        const feedbackP = document.getElementById('newsletter-feedback');
        feedbackP.textContent = 'Subscribing...';

        try {
            const response = await fetch('/api/contact/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: emailInput.value }),
            });

            if (response.ok) {
                feedbackP.textContent = 'Success! Check your inbox.';
                feedbackP.style.color = 'var(--color-accent)';
                form.reset();
            } else {
                const error = await response.json();
                feedbackP.textContent = `Error: ${(error && error.detail) || 'Subscription failed.'}`;
                feedbackP.style.color = '#ff6b6b'; // Simple error color
            }
        } catch (error) {
            console.error('Newsletter subscription error:', error);
            feedbackP.textContent = 'Error: Could not reach server.';
            feedbackP.style.color = '#ff6b6b';
        } finally {
             // Optionally clear feedback after a few seconds
             setTimeout(() => { feedbackP.textContent = ''; }, 5000);
        }
    }


    document.addEventListener('DOMContentLoaded', function() {
        loadLatestContent();

        const newsletterForm = document.getElementById('home-newsletter-form');
        if (newsletterForm) {
            newsletterForm.addEventListener('submit', handleNewsletterSubmit);
        }
    });
</script>
{% endblock %}
